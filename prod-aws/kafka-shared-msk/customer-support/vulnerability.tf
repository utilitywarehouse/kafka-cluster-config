resource "kafka_topic" "vulnerability_v6" {
  config = {
    "cleanup.policy" = "delete"
    # Recommended by dev-ena
    "compression.type" = "zstd"
    # Use tiered storage
    "remote.storage.enable" = "true"
    # keep data in primary storage for 1 day
    "local.retention.ms" = "86400000"
    # keep data forever
    # tflint-ignore: msk_topic_no_infinite_retention, # infinite retention because ...
    "retention.ms" = "-1"
  }
  name               = "customer-support.vulnerability_v6"
  partitions         = 15
  replication_factor = 3
}

module "vulnerability_service" {
  source           = "../../../modules/tls-app"
  cert_common_name = "crm/vulnerability-service"
  produce_topics   = [kafka_topic.vulnerability_v6.name]
}

module "vulnerability_fabricator" {
  source           = "../../../modules/tls-app"
  cert_common_name = "crm/vulnerability-fabricator"
  produce_topics   = [kafka_topic.vulnerability_v6.name]
}

module "vulnerability_risk_score_producer" {
  source           = "../../../modules/tls-app"
  cert_common_name = "crm/vulnerability-risk-score-producer"
  consume_topics   = [kafka_topic.vulnerability_v6.name]
  produce_topics   = [kafka_topic.vulnerability_v6.name]
  consume_groups   = ["customer-support.vulnerability-risk-score-producer-003"]
}

module "vulnerability_projector" {
  source           = "../../../modules/tls-app"
  cert_common_name = "crm/vulnerability-projector"
  consume_topics   = [kafka_topic.vulnerability_v6.name]
  consume_groups   = ["customer-support.vulnerability-projector-v2-20092023-1"]
}

module "vulnerability_projector_bill" {
  source           = "../../../modules/tls-app"
  cert_common_name = "crm/vulnerability-projector-bill"
  consume_topics   = [kafka_topic.vulnerability_v6.name]
  consume_groups   = ["customer-support.vulnerability-projector-bill-001"]
}

module "vulnerability_ticket_creator" {
  source           = "../../../modules/tls-app"
  cert_common_name = "crm/vulnerability-ticket-creator"
  consume_topics   = [kafka_topic.vulnerability_v6.name]
  consume_groups   = ["customer-support.vulnerability-ticket-creator"]
}

# Benthos -> BQ assessments
module "vulnerability_bq_v1" {
  source           = "../../../modules/tls-app"
  cert_common_name = "crm/vulnerability-bq-v1"
  consume_topics   = [kafka_topic.vulnerability_v6.name]
  consume_groups   = ["customer-support.vulnerability-assessments-benthos-bq-21092023-1"]
}

# Benthos -> BQ scores
module "vulnerability_bq_v1_scores" {
  source           = "../../../modules/tls-app"
  cert_common_name = "crm/vulnerability-bq-scores"
  consume_topics   = [kafka_topic.vulnerability_v6.name]
  consume_groups   = ["customer-support.vulnerability-scores-benthos-bq-21092023-1"]
}

# Import batch job for Origin customers
module "vulnerability_origin_importer" {
  source           = "../../../modules/tls-app"
  cert_common_name = "crm/vulnerability-origin-importer"
  produce_topics   = [kafka_topic.vulnerability_v6.name]
}

# Batch job to remove assessments that are erroneous
module "vulnerability_assessment_remover" {
  source           = "../../../modules/tls-app"
  cert_common_name = "crm/vulnerability-assessment-remover"
  produce_topics   = [kafka_topic.vulnerability_v6.name]
}
