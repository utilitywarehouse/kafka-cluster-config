resource "kafka_topic" "vulnerability_v7" {
  config = {
    # Recommended by dev-ena
    "compression.type" = "zstd"
    # Use tiered storage
    "remote.storage.enable" = "true"
    # keep data in hot storage for a day
    "local.retention.ms" = "86400000"
    # keep data forever
    "retention.ms" = "-1"
  }
  name               = "customer-support.vulnerability_v7"
  partitions         = 5
  replication_factor = 3
}

module "vulnerability_service" {
  source           = "../../../modules/tls-app"
  cert_common_name = "customer-support/vulnerability-service"
  produce_topics   = [kafka_topic.vulnerability_v7.name]
}

module "vulnerability_fabricator" {
  source           = "../../../modules/tls-app"
  cert_common_name = "customer-support/vulnerability-fabricator"
  produce_topics   = [kafka_topic.vulnerability_v7.name]
}

module "vulnerability_risk_score_producer" {
  source           = "../../../modules/tls-app"
  cert_common_name = "customer-support/vulnerability-risk-score-producer"
  consume_topics   = [kafka_topic.vulnerability_v7.name]
  produce_topics   = [kafka_topic.vulnerability_v7.name]
  consume_groups   = ["customer-support.vulnerability-risk-score-producer-018"]
}

module "vulnerability_projector" {
  source           = "../../../modules/tls-app"
  cert_common_name = "customer-support/vulnerability-projector"
  consume_topics   = [kafka_topic.vulnerability_v7.name]
  consume_groups   = ["customer-support.vulnerability-projector-v2-18092023-1"]
}

module "vulnerability_projector_bill" {
  source           = "../../../modules/tls-app"
  cert_common_name = "customer-support/vulnerability-projector-bill"
  consume_topics   = [kafka_topic.vulnerability_v7.name]
  consume_groups   = ["customer-support.vulnerability-v4-projector-bill-002"]
}

module "vulnerability_ticket_creator" {
  source           = "../../../modules/tls-app"
  cert_common_name = "customer-support/vulnerability-ticket-creator"
  consume_topics   = [kafka_topic.vulnerability_v7.name]
  consume_groups   = ["customer-support.vulnerability-ticket-creator"]
}
